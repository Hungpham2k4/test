name: Notify on PR to Main

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - closed
      - ready_for_review
      - review_requested
      - review_request_removed
      - reopened

jobs:
  notify:
    runs-on: self-hosted
    steps:
      - name: Send Telegram message
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        shell: powershell
        run: |
          function Escape-Markdown {
            param ([string]$text)
            return $text -replace '([\\_\*\[\]\(\)\~\`\>\#\+\-\=\|\{\}\.\!])', '\\$1'
          }

          $actor = Escape-Markdown $env:GITHUB_ACTOR
          $repo = Escape-Markdown $env:GITHUB_REPOSITORY
          $prNumber = "${{ github.event.pull_request.number }}"
          $action = Escape-Markdown "${{ github.event.action }}"
          $prTitle = Escape-Markdown "${{ github.event.pull_request.title }}"
          $sourceBranch = Escape-Markdown "${{ github.event.pull_request.head.ref }}"
          $targetBranch = Escape-Markdown "${{ github.event.pull_request.base.ref }}"

          $message = @"
          ğŸ“£ *Pull Request Activity*
          ğŸ‘¤ Actor: $actor
          ğŸ”§ Action: $action
          ğŸ“‚ Repo: $repo
          ğŸŒ¿ From: `$sourceBranch` â†’ `$targetBranch`
          ğŸ“ Title: *$prTitle*
          ğŸ”— PR: [View PR](https://github.com/$repo/pull/$prNumber)
          "@

          Invoke-RestMethod -Uri "https://api.telegram.org/bot$env:TELEGRAM_TOKEN/sendMessage" `
            -Method Post `
            -ContentType "application/x-www-form-urlencoded" `
            -Body @{
            chat_id = "$env:TELEGRAM_CHAT_ID"
            text = $message
            parse_mode = "MarkdownV2"
            }
