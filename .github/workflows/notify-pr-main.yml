name: Notify on PR to Main

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - closed
      - ready_for_review
      - review_requested
      - review_request_removed
      - reopened

jobs:
  notify:
    runs-on: self-hosted
    steps:
      - name: Send Telegram message
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        shell: powershell
        run: |
          # Escape markdown special characters
          $actor = $env:GITHUB_ACTOR -replace '([_\*\[\]\(\)\~\>\#\+\-\=\|\{\}\.\!])', '\\$1'
          $repo = $env:GITHUB_REPOSITORY -replace '([_\*\[\]\(\)\~\>\#\+\-\=\|\{\}\.\!])', '\\$1'
          $prNumber = "${{ github.event.pull_request.number }}"
          $action = "${{ github.event.action }}" -replace '([_\*\[\]\(\)\~\>\#\+\-\=\|\{\}\.\!])', '\\$1'
          $prTitle = "${{ github.event.pull_request.title }}" -replace '([_\*\[\]\(\)\~\>\#\+\-\=\|\{\}\.\!])', '\\$1'
          $sourceBranch = "${{ github.event.pull_request.head.ref }}" -replace '([_\*\[\]\(\)\~\>\#\+\-\=\|\{\}\.\!])', '\\$1'
          $targetBranch = "${{ github.event.pull_request.base.ref }}" -replace '([_\*\[\]\(\)\~\>\#\+\-\=\|\{\}\.\!])', '\\$1'

          $message = @"
          ğŸ“£ *Pull Request Activity*
          ğŸ‘¤ Actor: $actor
          ğŸ”§ Action: $action
          ğŸ“‚ Repo: $repo
          ğŸŒ¿ From: `$sourceBranch` â†’ `$targetBranch`
          ğŸ“ Title: *$prTitle*
          ğŸ”— PR: [View PR](https://github.com/$repo/pull/$prNumber)
          "@

          Invoke-RestMethod -Uri "https://api.telegram.org/bot$env:TELEGRAM_TOKEN/sendMessage" `
            -Method Post `
            -ContentType "application/x-www-form-urlencoded" `
            -Body @{
            chat_id = "$env:TELEGRAM_CHAT_ID"
            text = $message
            parse_mode = "MarkdownV2"
            }
